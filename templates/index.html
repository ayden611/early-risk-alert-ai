from flask import Flask, render_template, request, redirect, url_for
import os
import sqlite3
import numpy as np
import joblib

app = Flask(__name__)

# ----------------------------
# Model load (safe for Render)
# ----------------------------
MODEL_PATH = os.path.join(os.path.dirname(__file__), "demo_model.pkl")
model = joblib.load(MODEL_PATH)

# ----------------------------
# Simple SQLite history (no Flask-SQLAlchemy needed)
# ----------------------------
DB_PATH = os.path.join(os.path.dirname(__file__), "predictions.db")

def init_db():
    with sqlite3.connect(DB_PATH) as conn:
        conn.execute("""
            CREATE TABLE IF NOT EXISTS history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                created_at TEXT DEFAULT (datetime('now')),
                age REAL,
                bmi REAL,
                exercise REAL,
                sys_bp REAL,
                dia_bp REAL,
                heart_rate REAL,
                risk TEXT,
                probability REAL
            )
        """)
init_db()

def save_history(row):
    with sqlite3.connect(DB_PATH) as conn:
        conn.execute("""
            INSERT INTO history (age,bmi,exercise,sys_bp,dia_bp,heart_rate,risk,probability)
            VALUES (?,?,?,?,?,?,?,?)
        """, row)

def get_history(limit=25):
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.execute("""
            SELECT created_at, age,bmi,exercise,sys_bp,dia_bp,heart_rate,risk,probability
            FROM history
            ORDER BY id DESC
            LIMIT ?
        """, (limit,))
        return cur.fetchall()

# ----------------------------
# Routes
# ----------------------------
@app.route("/", methods=["GET", "POST"])
def home():
    # defaults for form re-fill
    form_vals = {
        "age": "",
        "bmi": "",
        "exercise": "",
        "sys_bp": "",
        "dia_bp": "",
        "heart_rate": ""
    }

    prediction = None
    probability = None
    risk_class = None  # "low" or "high"

    if request.method == "POST":
        # read inputs
        form_vals["age"] = request.form.get("age", "")
        form_vals["bmi"] = request.form.get("bmi", "")
        form_vals["exercise"] = request.form.get("exercise", "")
        form_vals["sys_bp"] = request.form.get("sys_bp", "")
        form_vals["dia_bp"] = request.form.get("dia_bp", "")
        form_vals["heart_rate"] = request.form.get("heart_rate", "")

        # convert to float safely
        age = float(form_vals["age"])
        bmi = float(form_vals["bmi"])
        exercise = float(form_vals["exercise"])
        sys_bp = float(form_vals["sys_bp"])
        dia_bp = float(form_vals["dia_bp"])
        heart_rate = float(form_vals["heart_rate"])

        data = np.array([[age, bmi, exercise, sys_bp, dia_bp, heart_rate]])

        pred = int(model.predict(data)[0])
        prob_high = float(model.predict_proba(data)[0][1])

        prediction = "High Risk" if pred == 1 else "Low Risk"
        probability = round(prob_high * 100, 2)

        risk_class = "high" if pred == 1 else "low"

        # save history
        save_history((age, bmi, exercise, sys_bp, dia_bp, heart_rate, prediction, probability))

    return render_template(
        "index.html",
        prediction=prediction,
        probability=probability,
        risk_class=risk_class,
        form_vals=form_vals
    )

@app.route("/history", methods=["GET"])
def history():
    rows = get_history(limit=30)
    return render_template("history.html", rows=rows)

# Render/Gunicorn entry point uses "app"
