{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h1>Prediction History</h1>

    <div class="kpis">
      <div class="kpi">
        <div class="kpi-title">Total Predictions</div>
        <div class="kpi-val">{{ total }}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">High Risk %</div>
        <div class="kpi-val">{{ high_pct }}%</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Avg High-Risk Prob</div>
        <div class="kpi-val">{{ avg_prob }}%</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Last 24 hours</div>
        <div class="kpi-val">{{ last_24h }}</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-card">
        <h3>Risk Split</h3>
        <canvas id="riskSplit"></canvas>
      </div>
      <div class="chart-card">
        <h3>Probability Trend (Last 30)</h3>
        <canvas id="probTrend"></canvas>
      </div>
    </div>

    <div class="filters">
      <div class="muted">Page {{ page }} / {{ pages }}</div>
      <div class="muted">Per page: {{ per_page }}</div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Age</th>
            <th>BMI</th>
            <th>Exercise</th>
            <th>Result</th>
            <th>Probability</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</td>
            <td>{{ "%.0f"|format(r.age) }}</td>
            <td>{{ "%.1f"|format(r.bmi) }}</td>
            <td>{{ exercise_to_label(r.exercise_level) }}</td>
            <td>
              <span class="tag {{ 'bad' if r.risk_label=='High Risk' else 'good' }}">
                {{ r.risk_label }}
              </span>
            </td>
            <td>{{ "%.2f"|format(r.probability * 100) }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="pager">
      <div>
        {% if page > 1 %}
          <a class="btn" href="{{ url_for('history', page=page-1, per_page=per_page) }}">Prev</a>
        {% else %}
          <span class="btn disabled">Prev</span>
        {% endif %}
      </div>

      <div>
        {% if page < pages %}
          <a class="btn" href="{{ url_for('history', page=page+1, per_page=per_page) }}">Next</a>
        {% else %}
          <span class="btn disabled">Next</span>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    const riskSplit = {{ risk_split_json | safe }};
    const trendLabels = {{ trend_labels_json | safe }};
    const trendProbs = {{ trend_probs_json | safe }};

    // Risk split bar
    new Chart(document.getElementById('riskSplit'), {
      type: 'bar',
      data: {
        labels: Object.keys(riskSplit),
        datasets: [{ label: 'Count', data: Object.values(riskSplit) }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    // Probability trend line
    new Chart(document.getElementById('probTrend'), {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{ label: 'High-Risk Probability (%)', data: trendProbs, tension: 0.25 }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  </script>
{% endblock %}
